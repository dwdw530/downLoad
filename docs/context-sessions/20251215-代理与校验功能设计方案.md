# Session: 代理支持与文件校验功能设计方案

## 元信息

- **创建时间**: 2025-12-15
- **项目路径**: D:\vscode_workspace\downLoad_project
- **状态**: 已实现（设计归档）

---

## 一、现状分析

### 1.1 代理支持现状

| 模块                | 位置                 | 现状                                  | 问题               |
|---------------------|----------------------|---------------------------------------|--------------------|
| config.py           | 第38-42行            | 有proxy配置结构{enabled, http, https} | 没有property访问器 |
| settings_dialog.py  | 全文件               | 完全没有代理UI组件                    | 用户无法配置       |
| chunk_downloader.py | 第162行              | requests.get()裸调用                  | 没有proxies参数    |
| download_engine.py  | 第63行               | requests.head()裸调用                 | 没有proxies参数    |
| download_engine.py  | 第195-206, 271-282行 | 创建ChunkDownloader                   | 不传proxy参数      |

**数据流断裂图：**
```
ConfigManager.proxy → ❌断裂 → DownloadEngine → ❌断裂 → ChunkDownloader → requests.get()
                                    ↓
                            check_url_support_range() → requests.head() ← ❌没有proxies
```

### 1.2 文件校验现状

| 模块               | 现状                             | 问题              |
|--------------------|----------------------------------|-------------------|
| db_manager.py      | download_tasks表没有校验字段     | 无法存储hash值    |
| file_utils.py      | 没有哈希计算函数                 | 缺少核心工具      |
| download_engine.py | _merge_and_finish直接标completed | 没有校验流程      |
| 任务状态           | 只有6种状态                      | 缺少verifying状态 |

**当前流程（无校验）：**
```
下载完成 → 合并文件 → 直接标记completed → 结束
```

---

## 二、实现方案

### 2.1 代理支持实现

#### 目标数据流
```
用户输入 → SettingsDialog(UI) → ConfigManager → DownloadEngine → ChunkDownloader → requests.get(proxies=...)
                                      ↓
                               check_url_support_range() → requests.head(proxies=...)
```

#### 改动清单

**文件1: downloader/utils/config.py**
- 位置：第174行后
- 改动：添加proxy属性访问器

```python
@property
def proxy(self) -> dict:
    """代理配置"""
    return self._config.get("proxy", {"enabled": False, "http": "", "https": ""})

@property
def proxy_enabled(self) -> bool:
    """代理是否启用"""
    return self.proxy.get("enabled", False)

@property
def proxies(self) -> dict | None:
    """获取requests可用的proxies字典"""
    if not self.proxy_enabled:
        return None
    proxy_cfg = self.proxy
    result = {}
    if proxy_cfg.get("http"):
        result["http"] = proxy_cfg["http"]
    if proxy_cfg.get("https"):
        result["https"] = proxy_cfg["https"]
    return result if result else None

def set_proxy(self, enabled: bool, http: str = "", https: str = ""):
    """设置代理配置"""
    self._config["proxy"] = {
        "enabled": enabled,
        "http": http.strip(),
        "https": https.strip()
    }
```

**文件2: downloader/ui/settings_dialog.py**
- 改动1：窗口高度从400改为520
- 改动2：在row=3（超时设置）后添加代理设置UI组件
  - 代理开关（CTkSwitch）
  - HTTP代理输入框
  - HTTPS代理输入框
- 改动3：速度限制从row=4改为row=5
- 改动4：添加_on_proxy_toggle方法控制输入框状态
- 改动5：_load_config加载代理配置
- 改动6：_on_save保存代理配置
- 改动7：_on_reset重置代理配置

**文件3: downloader/core/chunk_downloader.py**
- 改动1：__init__添加proxies: dict = None参数
- 改动2：保存self.proxies = proxies
- 改动3：第162行requests.get()添加proxies=self.proxies

**文件4: downloader/core/download_engine.py**
- 改动1：第63行requests.head()添加proxies=self.config.proxies
- 改动2：第195-206行创建ChunkDownloader添加proxies=self.config.proxies
- 改动3：第271-282行创建ChunkDownloader添加proxies=self.config.proxies

---

### 2.2 文件校验实现

#### 目标流程
```
下载完成 → 合并文件 → 状态改为verifying → 计算哈希 →
                                              ↓
                                        有预期哈希？
                                         ↓      ↓
                                        是      否
                                         ↓      ↓
                                      对比验证  直接显示
                                       ↓   ↓     ↓
                                     匹配 不匹配 completed
                                       ↓    ↓
                                 completed verify_failed
```

#### 改动清单

**文件1: downloader/utils/file_utils.py**
- 改动：添加哈希计算函数

```python
import hashlib

def calculate_file_hash(file_path: str, hash_type: str = "md5",
                        progress_callback=None) -> str:
    """
    计算文件哈希值（分块读取，支持大文件）
    Args:
        file_path: 文件路径
        hash_type: md5/sha256
        progress_callback: 进度回调 callback(processed, total)
    Returns:
        哈希值字符串（小写），失败返回空字符串
    """
    # 8MB分块读取，平衡速度和内存

def verify_file_hash(file_path: str, expected_hash: str, hash_type: str = "md5") -> bool:
    """验证文件哈希是否匹配"""
```

**文件2: downloader/database/db_manager.py**
- 改动1：download_tasks表添加字段
  - expected_hash TEXT - 预期哈希值
  - expected_hash_type TEXT - 哈希类型(md5/sha256)
  - actual_hash TEXT - 实际哈希值
  - hash_verified INTEGER DEFAULT 0 - 校验结果(0未校验/1匹配/-1不匹配)
- 改动2：添加兼容老数据库的ALTER TABLE语句
- 改动3：添加方法
  - update_task_hash(task_id, actual_hash, hash_verified)
  - set_expected_hash(task_id, expected_hash, hash_type)

**文件3: downloader/core/download_engine.py**
- 改动1：导入calculate_file_hash
- 改动2：修改_merge_and_finish，合并成功后调用_verify_and_finish
- 改动3：新增_verify_and_finish方法（校验核心逻辑）
- 改动4：新增_finish_task方法（完成任务公共逻辑）
- 改动5：修改download_and_finish（单线程），同样调用校验流程

**文件4: downloader/ui/main_window.py**
- 改动1：_get_status_text添加verifying和verify_failed状态映射
- 改动2：_update_task_status处理新状态的按钮显示
- 改动3：创建AddTaskDialog类（带哈希输入的任务对话框）
- 改动4：修改_on_add_task使用新对话框

---

## 三、关键文件列表

| 优先级 | 文件路径                            | 改动类型            |
|--------|-------------------------------------|---------------------|
| P0     | downloader/utils/config.py          | 添加proxy属性       |
| P0     | downloader/core/chunk_downloader.py | 添加proxies参数     |
| P0     | downloader/core/download_engine.py  | 代理传递+校验流程   |
| P0     | downloader/utils/file_utils.py      | 添加哈希函数        |
| P0     | downloader/database/db_manager.py   | 添加校验字段        |
| P1     | downloader/ui/settings_dialog.py    | 代理配置UI          |
| P1     | downloader/ui/main_window.py        | 状态显示+任务对话框 |

---

## 四、实现步骤

### 第一阶段：代理核心（P0）
1. config.py - 添加proxy属性访问器
2. chunk_downloader.py - 添加proxies参数
3. download_engine.py - 全链路传递代理

### 第二阶段：代理UI（P1）
4. settings_dialog.py - 添加代理配置UI

### 第三阶段：校验核心（P0）
5. file_utils.py - 添加哈希计算函数
6. db_manager.py - 添加校验字段和方法
7. download_engine.py - 添加校验流程

### 第四阶段：校验UI（P1）
8. main_window.py - 更新状态显示和添加任务对话框

---

## 五、测试验证

### 代理测试
1. 启动本地代理服务器（clash/v2ray等）
2. 设置中配置代理地址（如http://127.0.0.1:7890）
3. 下载文件，确认流量走代理

### 校验测试
1. 下载已知MD5的文件（如Linux ISO）
2. 输入正确哈希值 → 验证通过
3. 输入错误哈希值 → 验证失败状态显示
4. 不输入哈希值 → 显示计算出的哈希

---

## 六、注意事项

1. **代理格式**：用户输入格式为 `http://host:port` 或 `socks5://host:port`
2. **大文件哈希**：分块读取（8MB），避免内存爆炸
3. **数据库兼容**：老版本数据库用ALTER TABLE添加新字段
4. **状态兼容**：verify_failed状态允许用户重试下载

---

*此方案由老王设计，遵循KISS原则*
*存档时间：2025-12-15*
